<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 狼人杀游戏</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            height: 100vh;
            color: white;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
            padding: 20px;
            gap: 20px;
        }
        
        .game-area {
            flex: 2;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }
        
        .log-area {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }
        
        .game-title {
            text-align: center;
            font-size: 2em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .start-game-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            text-align: center;
        }
        
        .welcome-message {
            font-size: 1.5em;
            margin-bottom: 30px;
            opacity: 0.9;
            max-width: 600px;
            line-height: 1.6;
        }
        
        .start-game-btn {
            padding: 20px 40px;
            font-size: 1.3em;
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .start-game-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 35px rgba(255, 107, 107, 0.4);
            background: linear-gradient(45deg, #ff5252, #e53935);
        }
        
        .start-game-btn:active {
            transform: translateY(-1px);
        }

        .mode-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 25px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 25px;
        }

        .mode-selector label {
            font-size: 1em;
            margin-right: 10px;
            cursor: pointer;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4ecdc4;
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }
        
        .connection-status {
            margin-top: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 0.9em;
        }
        
        .connected {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid rgba(76, 175, 80, 0.5);
        }
        
        .disconnected {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid rgba(244, 67, 54, 0.5);
        }
        
        .game-content {
            display: none;
            flex-direction: column;
            flex: 1;
            height: 100%;
        }
        
        .phase-indicator {
            text-align: center;
            font-size: 1.3em;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }
        
        .player {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .speaking-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 15px;
            height: 15px;
            background-color: #4caf50;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 10px #4caf50, 0 0 20px #4caf50;
            animation: pulse 1.5s infinite;
            display: none;
        }

        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0.9); opacity: 0.7; }
        }
        
        .player:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.3);
        }
        
        .player-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-bottom: 10px;
            border: 3px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            overflow: hidden;
        }
        
        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .player-avatar .player-id {
            position: absolute;
            bottom: -2px;
            right: -2px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            border: 2px solid white;
        }
        
        .player-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .player-role {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .player-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-top: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
            height: 20px;
        }

        .player:hover .player-controls {
            opacity: 1;
        }

        .volume-icon {
            font-size: 1em;
            margin-right: 5px;
            line-height: 1;
        }

        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 70%;
            height: 5px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            outline: none;
            transition: opacity .2s;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            background: #ff6b6b;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
        }

        .volume-slider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            background: #ff6b6b;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
        }

        .dead {
            opacity: 0.5;
        }
        
        .dead .player-avatar {
            filter: grayscale(100%);
        }
        
        .speech-area {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        
        .speech-bubble {
            background: white;
            color: black;
            padding: 10px 15px;
            border-radius: 20px;
            margin: 10px 0;
            max-width: 80%;
            position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            animation: fadeInUp 0.3s ease;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .speech-bubble .avatar-small {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #ddd;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .speech-bubble .avatar-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .speech-content {
            flex: 1;
            padding-top: 2px;
            word-break: break-word;
        }
        
        .speech-bubble:before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20px;
            width: 0px;
            height: 0px;
            border: 10px solid;
            border-color: transparent transparent white transparent;
            transform: translateY(8px);
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .controls {
            flex-shrink: 0;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            width: 100%;
        }
        
        input[type="text"], input[type="number"] {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            background: rgba(255, 255, 255, 0.9);
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: #ff6b6b;
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        button:hover {
            background: #ff5252;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .skip-btn {
            background: #4ecdc4;
        }
        
        .skip-btn:hover {
            background: #26d0ce;
        }
        
        .log-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .log-content {
            flex-grow: 1;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
            animation: fadeIn 0.3s ease;
            font-size: 0.9em;
            word-wrap: break-word;
        }
        
        .log-entry.error {
            border-left-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }
        
        .log-entry.success {
            border-left-color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .hidden {
            display: none !important;
        }
        
        .timer {
            text-align: center;
            font-size: 1.5em;
            margin: 10px 0;
            color: #ff6b6b;
            flex-shrink: 0;
        }
        
        .role-info {
            text-align: center;
            font-size: 1.1em;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            flex-shrink: 0;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-area">
            <h1 class="game-title">🌙 AI 狼人杀 🌙</h1>
            
            <div class="start-game-screen" id="startGameScreen">
                <div class="welcome-message">
                    欢迎来到狼人杀游戏！<br>
                    在这个充满策略与推理的游戏中，你将与电脑玩家一同游戏。<br>
                    准备好挑战你的逻辑思维了吗？
                </div>
                <button class="start-game-btn" id="startGameBtn" onclick="startGame()">
                    <span id="startBtnText">开始游戏</span>
                    <span id="startBtnLoading" class="loading hidden"></span>
                </button>
                
                <div class="mode-selector">
                    <label for="voiceToggle">🎤 启用语音模式</label>
                    <label class="switch">
                        <input type="checkbox" id="voiceToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="connection-status" id="connectionStatus">
                    连接服务器中...
                </div>
            </div>
            
            <div class="game-content" id="gameContent">
                <div class="role-info" id="roleInfo">正在分配身份...</div>
                <div class="phase-indicator" id="phaseIndicator">游戏准备中...</div>
                <div class="timer hidden" id="timer"></div>
                <div class="players-grid" id="playersGrid"></div>
                <div class="speech-area" id="speechArea"></div>
                
                <div class="controls">
                    <div class="input-group hidden" id="speechInput">
                        <input type="text" id="speechText" placeholder="请输入发言内容...">
                        <button onclick="sendSpeech()">发言</button>
                    </div> 

                    <div class="input-group hidden" id="discussionInput">
                        <input type="text" id="discussionText" placeholder="自由讨论发言...">
                        <button onclick="sendDiscussionSpeech()">发言</button>
                        <button class="skip-btn" onclick="skipDiscussion()">跳过</button>
                    </div>
                    
                    <div class="input-group hidden" id="voteInput">
                        <input type="number" id="voteTarget" placeholder="投票目标编号" min="1" max="7">
                        <button onclick="sendVote()">投票</button>
                    </div>
                    
                    <div class="input-group hidden" id="nightInput">
                        <input type="number" id="nightTarget" placeholder="淘汰目标编号" min="1" max="7">
                        <button onclick="sendNightAction()">确认</button>
                    </div>
                    
                    <div class="input-group hidden" id="seerInput">
                        <input type="number" id="seerTarget" placeholder="查验目标编号" min="1" max="7">
                        <button onclick="sendSeerAction()">查验</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="log-area">
            <h2 class="log-title">📜 游戏记录</h2>
            <div class="log-content" id="logContent"></div>
        </div>
    </div>

    <script>
        const socket = io();
        let gameState = null;
        let discussionTimer = null;
        let isConnected = false;
        let gameStarted = false;

        let audioContext;
        const audioQueues = {};
        const isPlaying = {};
        const playerGains = {};

        function initAudioContext() {
            if (!audioContext && (window.AudioContext || window.webkitAudioContext)) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                    addLogEntry('音频系统已准备就绪。', 'success');
                } catch (e) {
                    addLogEntry('错误：您的浏览器不支持Web Audio API。', 'error');
                    console.error("Web Audio API is not supported in this browser", e);
                }
            }
        }
        
        socket.on('play_audio_chunk', function(data) {
            initAudioContext();
            if (!audioContext) return;

            const { playerId, audioChunk } = data;

            const binaryString = window.atob(audioChunk);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const arrayBuffer = bytes.buffer;

            audioContext.decodeAudioData(arrayBuffer, (decodedBuffer) => {
                if (!audioQueues[playerId]) {
                    audioQueues[playerId] = [];
                }
                audioQueues[playerId].push(decodedBuffer);
                
                if (!isPlaying[playerId]) {
                    playNextChunk(playerId);
                }
            }, (error) => {
                console.error(`Error decoding audio data for player ${playerId}:`, error);
                addLogEntry(`解码玩家 ${playerId} 的音频失败`, 'error');
            });
        });

        function playNextChunk(playerId) {
            if (!audioQueues[playerId] || audioQueues[playerId].length === 0) {
                isPlaying[playerId] = false;
                updateSpeakingIndicator(playerId, false);
                return;
            }

            isPlaying[playerId] = true;
            updateSpeakingIndicator(playerId, true);

            if (!playerGains[playerId]) {
                playerGains[playerId] = audioContext.createGain();
                playerGains[playerId].connect(audioContext.destination);
                const slider = document.querySelector(`.volume-slider[data-player-id='${playerId}']`);
                if (slider) {
                    playerGains[playerId].gain.value = slider.value;
                }
            }

            const bufferToPlay = audioQueues[playerId].shift();
            const source = audioContext.createBufferSource();
            source.buffer = bufferToPlay;
            source.connect(playerGains[playerId]);
            source.start();

            source.onended = () => {
                playNextChunk(playerId);
            };
        }

        function handleVolumeChange(sliderElement, playerId) {
            const volume = parseFloat(sliderElement.value);
            if (audioContext && playerGains[playerId]) {
                playerGains[playerId].gain.setTargetAtTime(volume, audioContext.currentTime, 0.01);
            }
        }

        function updateSpeakingIndicator(playerId, isSpeaking) {
            const playerDiv = document.querySelector(`.player[data-player-id='${playerId}']`);
            if (playerDiv) {
                const indicator = playerDiv.querySelector('.speaking-indicator');
                if (indicator) {
                    indicator.style.display = isSpeaking ? 'block' : 'none';
                }
            }
        }

        socket.on('connect', function() {
            isConnected = true;
            updateConnectionStatus();
            addLogEntry('已连接到游戏服务器', 'success');
        });
        
        socket.on('disconnect', function() {
            isConnected = false;
            updateConnectionStatus();
            addLogEntry('与服务器断开连接', 'error');
        });
        
        socket.on('seer_challenge_prompt', function(data) {
            let messageDiv = document.createElement('div');
            messageDiv.className = 'log-entry';
            messageDiv.style.borderLeftColor = '#ffc107';
            messageDiv.style.textAlign = 'center';

            let messageText = document.createElement('p');
            messageText.textContent = data.message;
            messageText.style.fontWeight = 'bold';
            messageDiv.appendChild(messageText);

            if (data.image_url) {
                let challengeImage = document.createElement('img');
                challengeImage.src = data.image_url;
                challengeImage.alt = '挑战提示';
                challengeImage.style.maxWidth = '80%';
                challengeImage.style.maxHeight = '150px';
                challengeImage.style.borderRadius = '10px';
                challengeImage.style.marginTop = '10px';
                messageDiv.appendChild(challengeImage);
            }

            let logArea = document.getElementById('logContent'); 
            if (logArea) {
                logArea.prepend(messageDiv); 
            } else {
                alert(data.message); 
            }
        });

        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            const startBtn = document.getElementById('startGameBtn');
            
            if (isConnected) {
                statusElement.textContent = '✅ 已连接到服务器';
                statusElement.className = 'connection-status connected';
                if (!gameStarted) {
                    startBtn.disabled = false;
                }
            } else {
                statusElement.textContent = '❌ 连接断开';
                statusElement.className = 'connection-status disconnected';
                startBtn.disabled = true;
            }
        }
        
        function startGame() {
            if (!isConnected) return;
            
            const voiceEnabled = document.getElementById('voiceToggle').checked;

            if (voiceEnabled) {
                initAudioContext();
            }
            
            gameStarted = true;
            const startBtn = document.getElementById('startGameBtn');
            const startBtnText = document.getElementById('startBtnText');
            const startBtnLoading = document.getElementById('startBtnLoading');
            
            startBtn.disabled = true;
            startBtnText.classList.add('hidden');
            startBtnLoading.classList.remove('hidden');
            
            socket.emit('start_game', { voice_enabled: voiceEnabled });
            
            addLogEntry(`正在创建新游戏 (语音: ${voiceEnabled ? '开启' : '关闭'})...`, 'success');
        }
        
        socket.on('game_started', function() {
            document.getElementById('startGameScreen').style.display = 'none';
            document.getElementById('gameContent').style.display = 'flex';
            addLogEntry('新游戏已开始！正在分配身份...', 'success');
            clearDiscussionTimer();
            hideAllInputs();
        });
        
        socket.on('game_state', function(state) {
            gameState = state;
            updateGameDisplay();
            updateRoleInfo();
            updateInputValidators();
        });
        
        socket.on('phase_update', function(phase) {
            document.getElementById('phaseIndicator').textContent = phase;
        });
        
        socket.on('new_speech', function(data) {
            addSpeechBubble(data.playerId, data.text);
        });
        
        socket.on('log_message', function(message) {
            addLogEntry(message);
        });
        
        socket.on('error_message', function(data) {
            addLogEntry(data.message, 'error');
            alert(data.message);
        });
        
        socket.on('request_speech', function(data) {
            showSpeechInput();
        });
        
        socket.on('start_discussion', function() {
            showDiscussionInput();
            startDiscussionTimer();
        });
        
        socket.on('discussion_ended', function() {
            hideDiscussionInput();
            clearDiscussionTimer();
        });
        
        socket.on('start_voting', function() {
            showVoteInput();
        });
        
        socket.on('voting_ended', function() {
            hideVoteInput();
        });
        
        socket.on('start_night_werewolf', function() {
            showNightInput();
        });
        
        socket.on('start_night_villager', function() {
            hideAllInputs();
        });
        
        socket.on('request_seer_action', function(data) {
            addLogEntry('夜晚：预言家请选择查验目标。', 'info');
            showSeerInput();
        });

        socket.on('seer_result', function(data) {
            addLogEntry(`夜晚查验结果：${data.target_id}号玩家的身份是 - ${data.role}`, 'success');
        });

        socket.on('game_end', function(data) {
            alert(`🎉 游戏结束！${data.winner}获胜！`);
            hideAllInputs();
            clearDiscussionTimer();
            addLogEntry(`游戏结束！${data.winner}获胜！`, 'success');
            
            setTimeout(() => {
                document.getElementById('startGameScreen').style.display = 'flex';
                document.getElementById('gameContent').style.display = 'none';
                document.getElementById('speechArea').innerHTML = '';
                
                const startBtn = document.getElementById('startGameBtn');
                const startBtnText = document.getElementById('startBtnText');
                const startBtnLoading = document.getElementById('startBtnLoading');
                
                startBtn.disabled = !isConnected;
                startBtnText.classList.remove('hidden');
                startBtnLoading.classList.add('hidden');
                startBtnText.textContent = '再来一局';
                
                startBtn.onclick = function() {
                    startGame();
                };
                
                addLogEntry('点击"再来一局"以开始新游戏', 'info');
            }, 3000);
        });
        
        function getPlayerAvatarPath(playerId) {
            return `/avatar/${playerId}`;
        }
        
        function updateInputValidators() {
            if (!gameState || !gameState.players) return;
            const maxPlayerId = gameState.players.length;
            
            const targetInputs = [
                document.getElementById('voteTarget'),
                document.getElementById('nightTarget'),
                document.getElementById('seerTarget')
            ];

            targetInputs.forEach(input => {
                if (input) {
                    input.setAttribute('max', maxPlayerId);
                }
            });
        }

        function updateGameDisplay() {
            if (!gameState) return;
            
            const grid = document.getElementById('playersGrid');
            grid.innerHTML = '';
            
            gameState.players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = `player ${!player.isAlive ? 'dead' : ''}`;
                playerDiv.dataset.playerId = player.id;
                const avatarPath = getPlayerAvatarPath(player.id);
                
                playerDiv.innerHTML = `
                    <div class="speaking-indicator"></div>
                    <div class="player-avatar" style="background-image: url('${avatarPath}');">
                        <div class="player-id">${player.id}</div>
                    </div>
                    <div class="player-name">${player.nickname}</div>
                    <div class="player-role">${player.isHuman ? '(你)' : '电脑'}</div>
                    <div class="player-controls">
                        <span class="volume-icon">🔊</span>
                        <input type="range" min="0" max="1.5" step="0.05" value="1" 
                               class="volume-slider" data-player-id="${player.id}"
                               oninput="handleVolumeChange(this, ${player.id})"
                               onclick="event.stopPropagation()">
                    </div>
                `;
                grid.appendChild(playerDiv);
            });
        }
        
        function updateRoleInfo() {
            if (!gameState || !gameState.humanId) return;
            const roleInfo = document.getElementById('roleInfo');
            const humanPlayer = gameState.players.find(p => p.isHuman);
            if(humanPlayer) {
                roleInfo.textContent = `你是 ${humanPlayer.nickname}(${gameState.humanId}号)，身份：${gameState.humanRole}`;
            }
        }
        
        function addSpeechBubble(playerId, text) {
            const speechArea = document.getElementById('speechArea');
            const bubble = document.createElement('div');
            bubble.className = 'speech-bubble';
            const avatarPath = getPlayerAvatarPath(playerId);

            let nickname = `玩家${playerId}`;
            if (gameState && gameState.players) {
                const player = gameState.players.find(p => p.id === playerId);
                if (player) {
                    nickname = player.nickname;
                }
            }
            
            bubble.innerHTML = `
                <div class="avatar-small" style="background-image: url('${avatarPath}');"></div>
                <div class="speech-content">
                    <strong>${nickname} (${playerId}号):</strong> ${text}
                </div>
            `;
            speechArea.appendChild(bubble);
            speechArea.scrollTop = speechArea.scrollHeight;
        }

        function addLogEntry(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        function showSpeechInput() {
            hideAllInputs();
            document.getElementById('speechInput').classList.remove('hidden');
            document.getElementById('speechText').focus();
        }
        
        function showDiscussionInput() {
            hideAllInputs();
            document.getElementById('discussionInput').classList.remove('hidden');
            document.getElementById('discussionText').focus();
        }
        
        function showVoteInput() {
            hideAllInputs();
            document.getElementById('voteInput').classList.remove('hidden');
            document.getElementById('voteTarget').focus();
        }
        
        function showNightInput() {
            hideAllInputs();
            document.getElementById('nightInput').classList.remove('hidden');
            document.getElementById('nightTarget').focus();
        }
        
        function showSeerInput() {
            hideAllInputs();
            document.getElementById('seerInput').classList.remove('hidden');
            document.getElementById('seerTarget').focus();
        }

        function hideAllInputs() {
            document.getElementById('speechInput').classList.add('hidden');
            document.getElementById('discussionInput').classList.add('hidden');
            document.getElementById('voteInput').classList.add('hidden');
            document.getElementById('nightInput').classList.add('hidden');
            document.getElementById('seerInput').classList.add('hidden');
        }
        
        function startDiscussionTimer() {
            let seconds = gameState ? (gameState.discussion_time || 60) : 60;
            const timer = document.getElementById('timer');
            timer.classList.remove('hidden');
            
            discussionTimer = setInterval(() => {
                timer.textContent = `⏰ ${seconds}秒`;
                seconds--;
                if (seconds < 0) {
                    clearDiscussionTimer();
                }
            }, 1000);
        }
        
        function clearDiscussionTimer() {
            if (discussionTimer) {
                clearInterval(discussionTimer);
                discussionTimer = null;
            }
            document.getElementById('timer').classList.add('hidden');
        }
        
        function sendSpeech() {
            const input = document.getElementById('speechText');
            const text = input.value.trim();
            if (!text) {
                addLogEntry('请输入发言内容', 'error');
                return;
            }
            socket.emit('send_speech', {text: text});
            input.value = '';
            hideAllInputs();
        }
        
        function sendDiscussionSpeech() {
            const input = document.getElementById('discussionText');
            const text = input.value.trim();
            if (!text) return;
            socket.emit('send_discussion_speech', {text: text});
            input.value = '';
        }
        
        function skipDiscussion() {
            socket.emit('skip_discussion');
        }
        
        function sendVote() {
            const input = document.getElementById('voteTarget');
            const target = parseInt(input.value);
            const maxPlayerId = gameState ? gameState.players.length : 7;
            if (!target || target < 1 || target > maxPlayerId) {
                addLogEntry(`请输入有效的玩家编号(1-${maxPlayerId})`, 'error');
                return;
            }
            if (!gameState) return;
            const humanPlayer = gameState.players.find(p => p.isHuman);
            if (target === humanPlayer.id) {
                addLogEntry('不能投票给自己', 'error');
                return;
            }
            const targetPlayer = gameState.players.find(p => p.id === target);
            if (!targetPlayer || !targetPlayer.isAlive) {
                addLogEntry('该玩家不存在或已被淘汰', 'error');
                return;
            }
            socket.emit('send_vote', {target: target});
            hideAllInputs();
        }
        
        function sendNightAction() {
            const input = document.getElementById('nightTarget');
            const target = parseInt(input.value);
            const maxPlayerId = gameState ? gameState.players.length : 7;
            if (!target || target < 1 || target > maxPlayerId) {
                addLogEntry(`请输入有效的玩家编号(1-${maxPlayerId})`, 'error');
                return;
            }
            if (!gameState) return;
            const humanPlayer = gameState.players.find(p => p.isHuman);
            if (target === humanPlayer.id) {
                addLogEntry('不能选择自己', 'error');
                return;
            }
            const targetPlayer = gameState.players.find(p => p.id === target);
            if (!targetPlayer || !targetPlayer.isAlive) {
                addLogEntry('该玩家已被淘汰', 'error');
                return;
            }
            socket.emit('send_night_action', {target: target});
            hideAllInputs();
        }
        
        function sendSeerAction() {
            const input = document.getElementById('seerTarget');
            const target = parseInt(input.value);
            const maxPlayerId = gameState ? gameState.players.length : 7;
            if (!target || target < 1 || target > maxPlayerId) {
                addLogEntry(`请输入有效的玩家编号(1-${maxPlayerId})`, 'error');
                return;
            }
            if (!gameState) return;
            const humanPlayer = gameState.players.find(p => p.isHuman);
            if (target === humanPlayer.id) {
                addLogEntry('不能查验自己', 'error');
                return;
            }
            const targetPlayer = gameState.players.find(p => p.id === target);
            if (!targetPlayer || !targetPlayer.isAlive) {
                addLogEntry('该玩家不存在或已被淘汰，无法查验', 'error');
                return;
            }
            socket.emit('send_seer_action', {target: target});
            hideAllInputs();
        }

        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (!document.getElementById('speechInput').classList.contains('hidden')) {
                    sendSpeech();
                } else if (!document.getElementById('discussionInput').classList.contains('hidden')) {
                    sendDiscussionSpeech();
                } else if (!document.getElementById('voteInput').classList.contains('hidden')) {
                    sendVote();
                } else if (!document.getElementById('nightInput').classList.contains('hidden')) {
                    sendNightAction();
                } else if (!document.getElementById('seerInput').classList.contains('hidden')) {
                    sendSeerAction();
                }
            }
        });
        
        updateConnectionStatus();
    </script>
</body>
</html>
